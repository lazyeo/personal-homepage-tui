---
interface Props {
  username?: string;
}

const { username = 'lazyeo' } = Astro.props;
---

<div class="github-heatmap" data-username={username}>
  <div class="github-heatmap__header">
    <span class="github-heatmap__title">GitHub Activity</span>
    <span class="github-heatmap__period">Last 30 days</span>
  </div>
  <div class="github-heatmap__grid" id="heatmap-grid">
    <!-- Will be filled by JavaScript -->
  </div>
  <div class="github-heatmap__legend">
    <span class="github-heatmap__legend-label">Less</span>
    <span class="github-heatmap__cell github-heatmap__cell--0">░</span>
    <span class="github-heatmap__cell github-heatmap__cell--1">▒</span>
    <span class="github-heatmap__cell github-heatmap__cell--2">▓</span>
    <span class="github-heatmap__cell github-heatmap__cell--3">█</span>
    <span class="github-heatmap__legend-label">More</span>
  </div>
</div>

<style is:global>
  .github-heatmap {
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .github-heatmap__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .github-heatmap__title {
    color: var(--accent-primary);
    font-weight: 700;
  }

  .github-heatmap__period {
    color: var(--text-muted);
    font-size: 0.7rem;
  }

  .github-heatmap__grid {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    margin-bottom: 0.5rem;
    line-height: 1;
  }

  .github-heatmap__loading {
    color: var(--text-muted);
    text-align: center;
    padding: 1rem 0;
  }

  .github-heatmap__cell {
    text-align: center;
    cursor: default;
    transition: transform 0.1s ease;
  }

  .github-heatmap__cell:hover {
    transform: scale(1.2);
  }

  .github-heatmap__cell--0 {
    color: var(--border-color);
  }

  .github-heatmap__cell--1 {
    color: var(--text-muted);
  }

  .github-heatmap__cell--2 {
    color: var(--text-secondary);
  }

  .github-heatmap__cell--3 {
    color: var(--accent-primary);
  }

  .github-heatmap__legend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    justify-content: flex-end;
  }

  .github-heatmap__legend-label {
    color: var(--text-muted);
    font-size: 0.65rem;
  }

  .github-heatmap__error {
    color: var(--text-secondary);
    font-size: 0.7rem;
  }

  @media (max-width: 768px) {
    .github-heatmap {
      margin-top: 1rem;
    }
  }
</style>

<script>
  import { playTickSound } from '../scripts/sound.js';

  async function initHeatmap() {
    const container = document.querySelector('.github-heatmap');
    const grid = document.getElementById('heatmap-grid');
    const username = container?.getAttribute('data-username') || 'lazyeo';

    if (!grid) return;

    // First, show empty cells
    grid.textContent = '';
    for (let i = 0; i < 30; i++) {
      const cell = document.createElement('span');
      cell.className = 'github-heatmap__cell github-heatmap__cell--0';
      cell.textContent = '░';
      grid.appendChild(cell);
    }

    // Then fetch and animate
    try {
      const contributions = await fetchContributions(username);
      await renderHeatmapAnimated(grid, contributions);
    } catch (error) {
      console.error('Failed to load GitHub heatmap:', error);
      await renderPlaceholderAnimated(grid);
    }
  }

  async function fetchContributions(username: string): Promise<number[]> {
    const response = await fetch(
      `https://github-contributions-api.jogruber.de/v4/${username}?y=last`
    );

    if (!response.ok) throw new Error('API request failed');

    const data = await response.json();
    const contributions = data.contributions || [];
    const last30Days = contributions.slice(-30);

    return last30Days.map((day: { count: number }) => day.count);
  }

  async function renderHeatmapAnimated(grid: HTMLElement, contributions: number[]) {
    const maxContrib = Math.max(...contributions, 1);
    const emptyChar = '░';
    const chars = ['░', '▒', '▓', '█'];

    // Clear grid and create empty cells first
    grid.textContent = '';

    const cells: HTMLSpanElement[] = [];

    contributions.forEach((count, index) => {
      const cell = document.createElement('span');
      cell.className = 'github-heatmap__cell github-heatmap__cell--0';
      cell.textContent = emptyChar;

      const date = new Date();
      date.setDate(date.getDate() - (29 - index));
      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      cell.title = `${dateStr}: ${count} contributions`;

      // Store the target level for animation
      let level = 0;
      if (count > 0) {
        if (count >= maxContrib * 0.75) level = 3;
        else if (count >= maxContrib * 0.5) level = 2;
        else level = 1;
      }
      cell.dataset.targetLevel = String(level);
      cell.dataset.targetChar = chars[level];

      grid.appendChild(cell);
      cells.push(cell);
    });

    // Animate cells one by one
    for (const cell of cells) {
      const level = cell.dataset.targetLevel || '0';
      const char = cell.dataset.targetChar || emptyChar;

      await sleep(30);

      cell.className = `github-heatmap__cell github-heatmap__cell--${level}`;
      cell.textContent = char;

      if (level !== '0') {
        playTickSound();
      }
    }
  }

  async function renderPlaceholderAnimated(grid: HTMLElement) {
    const chars = ['░', '▒', '▓', '█'];
    const pattern = [
      0, 1, 0, 2, 1, 0, 1, 2, 0, 1,
      1, 0, 2, 1, 3, 1, 0, 1, 2, 0,
      0, 2, 1, 0, 1, 2, 3, 1, 0, 1
    ];

    grid.textContent = '';

    const cells: HTMLSpanElement[] = [];

    pattern.forEach((level, i) => {
      const cell = document.createElement('span');
      cell.className = 'github-heatmap__cell github-heatmap__cell--0';
      cell.textContent = '░';
      cell.title = `Day ${i + 1}`;
      cell.dataset.targetLevel = String(level);
      cell.dataset.targetChar = chars[level];
      grid.appendChild(cell);
      cells.push(cell);
    });

    // Animate cells one by one
    for (const cell of cells) {
      const level = cell.dataset.targetLevel || '0';
      const char = cell.dataset.targetChar || '░';

      await sleep(30);

      cell.className = `github-heatmap__cell github-heatmap__cell--${level}`;
      cell.textContent = char;

      if (level !== '0') {
        playTickSound();
      }
    }

    const error = document.createElement('div');
    error.className = 'github-heatmap__error';
    error.style.cssText = 'margin-top: 0.5rem; width: 100%;';
    error.textContent = '(Demo data - API unavailable)';
    grid.appendChild(error);
  }

  function sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  initHeatmap();
  document.addEventListener('astro:page-load', initHeatmap);
</script>
